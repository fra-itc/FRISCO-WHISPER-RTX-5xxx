{% extends "base.html" %}

{% block title %}Upload - Frisco Whisper RTX{% endblock %}
{% block nav_upload %}active{% endblock %}

{% block content %}
<div class="upload-page">
    <!-- Page Header -->
    <div class="page-header">
        <h1>
            <i class="fas fa-upload"></i>
            Upload Audio File
        </h1>
        <p>Upload your audio file for GPU-accelerated transcription. Supported formats: MP3, WAV, M4A, MP4, AAC, FLAC, OPUS</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <div class="upload-card">
            <!-- Drag and Drop Zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Drag & Drop Audio File</h3>
                <p>or</p>
                <button type="button" class="btn btn-primary" id="selectFileBtn">
                    <i class="fas fa-folder-open"></i>
                    Select File
                </button>
                <input type="file" id="fileInput" accept=".mp3,.wav,.m4a,.mp4,.aac,.flac,.opus" style="display: none;">
                <div class="file-info">
                    <small>Maximum file size: 500 MB</small>
                </div>
            </div>

            <!-- Upload Progress -->
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-header">
                    <span id="uploadFileName">Uploading...</span>
                    <span id="uploadPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="uploadProgressBar"></div>
                </div>
                <div class="progress-info">
                    <small id="uploadSize">0 MB / 0 MB</small>
                </div>
            </div>

            <!-- File Selected Info -->
            <div class="file-selected" id="fileSelected" style="display: none;">
                <div class="file-icon">
                    <i class="fas fa-file-audio"></i>
                </div>
                <div class="file-details">
                    <h4 id="selectedFileName">file.mp3</h4>
                    <p id="selectedFileSize">0 MB</p>
                </div>
                <button type="button" class="btn btn-secondary btn-sm" id="removeFileBtn">
                    <i class="fas fa-times"></i>
                    Remove
                </button>
            </div>
        </div>

        <!-- Transcription Options -->
        <div class="options-card" id="optionsCard" style="display: none;">
            <h3>
                <i class="fas fa-cog"></i>
                Transcription Options
            </h3>

            <form id="transcriptionForm">
                <div class="form-group">
                    <label for="modelSize">
                        <i class="fas fa-brain"></i>
                        Model Size
                    </label>
                    <select id="modelSize" name="model_size" class="form-control">
                        <option value="tiny">Tiny (fastest, least accurate)</option>
                        <option value="base">Base (fast)</option>
                        <option value="small">Small (balanced)</option>
                        <option value="medium">Medium (accurate)</option>
                        <option value="large-v3" selected>Large-v3 (most accurate, GPU recommended)</option>
                        <option value="large-v2">Large-v2 (previous version)</option>
                    </select>
                    <small class="form-help">Larger models are more accurate but slower</small>
                </div>

                <div class="form-group">
                    <label for="taskType">
                        <i class="fas fa-tasks"></i>
                        Task Type
                    </label>
                    <select id="taskType" name="task_type" class="form-control">
                        <option value="transcribe" selected>Transcribe (maintain original language)</option>
                        <option value="translate">Translate (to English)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="language">
                        <i class="fas fa-language"></i>
                        Language (optional)
                    </label>
                    <select id="language" name="language" class="form-control">
                        <option value="">Auto-detect</option>
                        <option value="en">English</option>
                        <option value="it">Italian</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="pt">Portuguese</option>
                        <option value="ru">Russian</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="ar">Arabic</option>
                        <option value="hi">Hindi</option>
                    </select>
                    <small class="form-help">Leave as auto-detect for best results</small>
                </div>

                <!-- Advanced Options -->
                <div class="advanced-toggle">
                    <button type="button" class="btn btn-link" id="advancedToggle">
                        <i class="fas fa-chevron-down"></i>
                        Advanced Options
                    </button>
                </div>

                <div class="advanced-options" id="advancedOptions" style="display: none;">
                    <div class="form-group">
                        <label for="beamSize">
                            <i class="fas fa-stream"></i>
                            Beam Size
                        </label>
                        <input type="range" id="beamSize" name="beam_size" min="1" max="10" value="5" class="form-range">
                        <div class="range-value">
                            <span>1</span>
                            <span id="beamSizeValue">5</span>
                            <span>10</span>
                        </div>
                        <small class="form-help">Higher values = more accurate but slower</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="vadFilter" name="vad_filter" checked>
                            <span>Enable VAD Filter</span>
                        </label>
                        <small class="form-help">Voice Activity Detection filters out non-speech segments</small>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-success btn-lg" id="startTranscriptionBtn">
                        <i class="fas fa-play"></i>
                        Start Transcription
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recent Jobs Preview -->
    <div class="recent-jobs-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-history"></i>
                Recent Jobs
            </h2>
            <a href="/jobs" class="btn btn-secondary">
                View All
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        <div class="jobs-preview" id="recentJobs">
            <div class="loading-spinner">
                <i class="fas fa-circle-notch fa-spin"></i>
                <p>Loading recent jobs...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Upload functionality
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const selectFileBtn = document.getElementById('selectFileBtn');
const fileSelected = document.getElementById('fileSelected');
const uploadProgress = document.getElementById('uploadProgress');
const optionsCard = document.getElementById('optionsCard');
const transcriptionForm = document.getElementById('transcriptionForm');
const advancedToggle = document.getElementById('advancedToggle');
const advancedOptions = document.getElementById('advancedOptions');
const beamSizeInput = document.getElementById('beamSize');
const beamSizeValue = document.getElementById('beamSizeValue');

let uploadedFilePath = null;

// File selection
selectFileBtn.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        handleFileSelect(file);
    }
});

// Drag and drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('drag-over');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');

    const file = e.dataTransfer.files[0];
    if (file) {
        handleFileSelect(file);
    }
});

// Remove file
document.getElementById('removeFileBtn').addEventListener('click', () => {
    resetUpload();
});

// Handle file selection
async function handleFileSelect(file) {
    // Validate file type
    const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/x-m4a', 'audio/aac', 'audio/flac', 'audio/opus'];
    const allowedExtensions = ['.mp3', '.wav', '.m4a', '.mp4', '.aac', '.flac', '.opus'];

    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        showToast('Invalid file type. Please upload an audio file.', 'error');
        return;
    }

    // Validate file size (500 MB)
    if (file.size > 500 * 1024 * 1024) {
        showToast('File too large. Maximum size is 500 MB.', 'error');
        return;
    }

    // Show file info
    document.getElementById('selectedFileName').textContent = file.name;
    document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);

    // Upload file
    await uploadFile(file);
}

// Upload file to server
async function uploadFile(file) {
    uploadZone.style.display = 'none';
    uploadProgress.style.display = 'block';

    document.getElementById('uploadFileName').textContent = file.name;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/v1/upload', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Upload failed');
        }

        const data = await response.json();
        uploadedFilePath = data.file_path;

        // Show success
        uploadProgress.style.display = 'none';
        fileSelected.style.display = 'flex';
        optionsCard.style.display = 'block';

        showToast('File uploaded successfully!', 'success');

    } catch (error) {
        console.error('Upload error:', error);
        showToast('Upload failed. Please try again.', 'error');
        resetUpload();
    }
}

// Reset upload form
function resetUpload() {
    uploadedFilePath = null;
    fileInput.value = '';
    uploadZone.style.display = 'block';
    uploadProgress.style.display = 'none';
    fileSelected.style.display = 'none';
    optionsCard.style.display = 'none';
}

// Advanced options toggle
advancedToggle.addEventListener('click', () => {
    const isVisible = advancedOptions.style.display !== 'none';
    advancedOptions.style.display = isVisible ? 'none' : 'block';
    advancedToggle.querySelector('i').className = isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
});

// Beam size slider
beamSizeInput.addEventListener('input', (e) => {
    beamSizeValue.textContent = e.target.value;
});

// Submit transcription
transcriptionForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!uploadedFilePath) {
        showToast('Please upload a file first', 'error');
        return;
    }

    const formData = {
        file_path: uploadedFilePath,
        model_size: document.getElementById('modelSize').value,
        task_type: document.getElementById('taskType').value,
        language: document.getElementById('language').value || null,
        beam_size: parseInt(document.getElementById('beamSize').value),
        vad_filter: document.getElementById('vadFilter').checked
    };

    try {
        const response = await fetch('/api/v1/transcribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            throw new Error('Failed to start transcription');
        }

        const data = await response.json();

        showToast('Transcription started! Redirecting to jobs page...', 'success');

        // Redirect to jobs page after 2 seconds
        setTimeout(() => {
            window.location.href = '/jobs';
        }, 2000);

    } catch (error) {
        console.error('Transcription error:', error);
        showToast('Failed to start transcription. Please try again.', 'error');
    }
});

// Load recent jobs
async function loadRecentJobs() {
    try {
        const response = await fetch('/api/v1/jobs?limit=5');
        const jobs = await response.json();

        const container = document.getElementById('recentJobs');

        if (jobs.length === 0) {
            container.innerHTML = '<p class="no-jobs">No jobs yet. Upload a file to get started!</p>';
            return;
        }

        container.innerHTML = jobs.map(job => `
            <div class="job-card-mini">
                <div class="job-status status-${job.status}">
                    ${getStatusIcon(job.status)}
                </div>
                <div class="job-info">
                    <h4>${job.file_name || 'Unknown file'}</h4>
                    <p><small>${formatDate(job.created_at)} â€¢ ${job.model_size}</small></p>
                </div>
                <a href="/jobs" class="btn btn-sm btn-secondary">View</a>
            </div>
        `).join('');

    } catch (error) {
        console.error('Failed to load recent jobs:', error);
        document.getElementById('recentJobs').innerHTML = '<p class="error-message">Failed to load recent jobs</p>';
    }
}

// Load recent jobs on page load
document.addEventListener('DOMContentLoaded', () => {
    loadRecentJobs();
});

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}
</script>
{% endblock %}
